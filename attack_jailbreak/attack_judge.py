import json, os
import sys, torch
parent_dir = '/data/root/prompt_new'
sys.path.append(parent_dir)
import utils.models as model
from transformers import AutoModelForCausalLM, AutoTokenizer
from transformers.generation.utils import GenerationConfig
import time

#########################   gpu   #######################
#########################   gpu   #######################
gpu_id = 999 # magic number
while(gpu_id not in range(0, torch.cuda.device_count())):
    input = input("请输入GPU编号：")
    gpu_id = int(input)

# 检查是否有可用的CUDA设备
if torch.cuda.is_available():
    device = torch.device(f"cuda:{gpu_id}")
    torch.cuda.set_device(gpu_id)  # 设置当前设备为指定的GPU
    print(f"Using CUDA device: {gpu_id} - {torch.cuda.get_device_name(gpu_id)}")
else:
    device = torch.device("cpu")
    print("CUDA is not available. Using CPU.")
#########################   gpu   #######################
#########################   gpu   #######################



def get_subdirectories(directory):
    subdirectories = [name for name in os.listdir(directory) if os.path.isdir(os.path.join(directory, name))]
    return subdirectories

def load_jsonl(file_path):
    datas = []
    with open(file_path, 'r') as f:
        for line in f:
            datas.append(json.loads(line))
    return datas

def result_statistics(datas):
    total_attempts = 0
    successful_attacks = 0
    
    for data in datas:
        total_attempts += 1
        if data['attack_success'] == "True":
            successful_attacks += 1

    if total_attempts > 0:
        success_rate = successful_attacks / total_attempts
    else:
        success_rate = 0

    print(f"Total Attempts: {total_attempts}")
    print(f"Successful Attacks: {successful_attacks}")
    print(f"Attack Success Rate: {success_rate:.2%}")

    return total_attempts, successful_attacks, success_rate

def main():
    current_directory = '/data/root/prompt_new/test_origin/result'
    subdirectories = get_subdirectories(current_directory)

    
    #model_list = ['gpt35', 'gpt4o', 'gpt4turb'] # done
    #model_list = ['qwenmax', 'qwenturbe']
    model_list = ['gpt4o', 'gpt4turb', 'qwenmax', 'qwenplus']

    
    checkpoint_path = '/data/root/prompt_new/llamaguard_judge/attack_jailbreak/checkpoint_main_'+model_list[0]+'.json'
    start_subdir_index = 0

    # Load the checkpoint if it exists
    if os.path.exists(checkpoint_path):
        with open(checkpoint_path, 'r') as checkpoint_file:
            checkpoint_data = json.load(checkpoint_file)
            start_subdir_index = checkpoint_data.get("last_processed_subdir_index", 0)

    for subdir_index, subdir in enumerate(subdirectories[start_subdir_index:], start=start_subdir_index):
        print(subdir_index, subdir)
        try:
            if(subdir in model_list):
                print(f"Processing {subdir}...")
                prompts_with_resp = '/data/root/prompt_new/llamaguard_judge/attack_jailbreak/'+subdir+'/goal_hijack.jsonl'
                file_path = prompts_with_resp
                output_path = os.path.join('/data/root/prompt_new/llamaguard_judge/attack_jailbreak/'+subdir+'/goal_hijack_judge.jsonl')
                datas = load_jsonl(file_path)
                model.new_judgment_llama_guard2(datas, device, 1, model_name=subdir, outputpath=output_path) # return STRING "True" if success else "False"
                # processing result
                datas = load_jsonl(output_path)
                result = result_statistics(datas)
                with open('/data/root/prompt_new/llamaguard_judge/attack_jailbreak/Attack_Success_Rate_ALL.jsonl', 'a') as f:
                    f.write(json.dumps({'model': subdir,
                                        'total_attempts': result[0],
                                        'successful_attacks': result[1],
                                        'attack_success_rate': result[2]}) + '\n')
                with open(checkpoint_path, 'w') as checkpoint_file:
                    json.dump({"last_processed_subdir_index": subdir_index + 1}, checkpoint_file)

        except Exception as e:
            print(f"An error occurred while processing {subdir}: {e}")
            break
    
    if subdir_index == len(subdirectories) - 1:
        if os.path.exists(checkpoint_path):
            os.remove(checkpoint_path)

    print('All Finish.')



if __name__ == '__main__':
    main() 